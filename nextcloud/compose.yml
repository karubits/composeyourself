
################################
# ðŸ“¦ NEXTCLOUD COMPOSE #
################################
# File sync, calendar, contacts, Talk, OnlyOffice; web, db, cache, cron, notify_push, turn, talk.
# ðŸ”— https://docs.nextcloud.com/server/stable/admin_manual/installation/docker/
################################

name: nextcloud
services:
  # ðŸ”¹ðŸ”¹ NEXTCLOUD WEB  ðŸ”¹ðŸ”¹
  # Main Nextcloud app (Apache); files, calendar, contacts, apps.
  # ðŸ”— https://nextcloud.com/
  # ðŸ”— https://github.com/nextcloud/server
  # ðŸ”— https://docs.nextcloud.com/server/stable/admin_manual/
  nextcloud-web:
    hostname: nextcloud-web
    container_name: nextcloud-web
    image: nextcloud:stable-apache
    restart: always
    volumes:
      - ${NEXTCLOUD_DATA_DIR}:/data
      - ${PATH_DATA}/nextcloud/web:/var/www/html
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
    environment:
      # Nextcloud
      - NEXTCLOUD_ADMIN_USER
      - NEXTCLOUD_ADMIN_PASSWORD
      - NEXTCLOUD_DATA_DIR=/data
      - NEXTCLOUD_TRUSTED_DOMAINS=hub.${DEFAULT_DOMAIN}
      # PHP and Apache
      - PHP_MEMORY_LIMIT=16G
      - PHP_UPLOAD_LIMIT=16G
      - APACHE_BODY_LIMIT=0
      - TRUSTED_PROXIES
      - OVERWRITEPROTOCOL=https
      # MYSQL
      - MYSQL_DATABASE=nextcloud
      - MYSQL_USER=nextcloud
      - MYSQL_PASSWORD
      - MYSQL_HOST=nextcloud-db
      # REDIS
      - REDIS_HOST=nextcloud-cache
      - REDIS_PORT=6379
      - REDIS_HOST_PASSWORD
      # SMTP Settings
      - MAIL_FROM_ADDRESS=hub@${DEFAULT_DOMAIN}
      - SMTP_HOST=${SMTP_SERVER}
      - SMTP_NAME=${SMTP_USER}
      - SMTP_PASSWORD=${SMTP_PASS}
      - SMTP_PORT=587
      - SMTP_SECURE=tls
    networks:
      - default
      - proxy
    labels:
      # Homepage
      - "homepage.description=nextcloud Media Server"
      - "homepage.group=Apps"
      - "homepage.href=https://hub.${DEFAULT_DOMAIN}"
      - "homepage.icon=nextcloud.png"
      - "homepage.name=Nextcloud"
      - "homepage.weight=3"
      - "homepage.widget.type=nextcloud"
      - "homepage.widget.url=https://hub.${DEFAULT_DOMAIN}" 
      - "homepage.widget.key=${TOKEN_SERVICE_INFO}"
      # Traefik 2
      - "traefik.docker.network=proxy"
      - "traefik.enable=true"
      - "traefik.http.services.nextcloud.loadbalancer.server.port=80"
      # add https proxy headers
      - "traefik.http.middlewares.nextcloud-headers.headers.browserXSSFilter=true"
      - "traefik.http.middlewares.nextcloud-headers.headers.contentTypeNosniff=true"
      - "traefik.http.middlewares.nextcloud-headers.headers.customFrameOptionsValue=SAMEORIGIN"
      - "traefik.http.middlewares.nextcloud-headers.headers.forceSTSHeader=true"
      - "traefik.http.middlewares.nextcloud-headers.headers.referrerPolicy=no-referrer"
      - "traefik.http.middlewares.nextcloud-headers.headers.sslRedirect=true"
      - "traefik.http.middlewares.nextcloud-headers.headers.stsIncludeSubdomains=true"
      - "traefik.http.middlewares.nextcloud-headers.headers.stsPreload=true"
      - "traefik.http.middlewares.nextcloud-headers.headers.stsSeconds=315360000"
      # Cal* Redirect
      - "traefik.http.middlewares.nextcloud-redirect.redirectRegex.permanent=true"
      - "traefik.http.middlewares.nextcloud-redirect.redirectRegex.regex=https://(.*)/.well-known/(card|cal)dav"
      - "traefik.http.middlewares.nextcloud-redirect.redirectRegex.replacement=https://$${1}/remote.php/dav/"
      # Router (priority=1 so /push can be routed to notify_push with higher priority)
      - "traefik.http.routers.nextcloud.priority=1"
      - "traefik.http.routers.nextcloud.middlewares=nextcloud-redirect,nextcloud-headers"
      - "traefik.http.routers.nextcloud.entrypoints=websecure"
      - "traefik.http.routers.nextcloud.rule=Host(`hub.${DEFAULT_DOMAIN}`)"
    depends_on:
      nextcloud-db:
          condition: service_healthy
      nextcloud-cache:
          condition: service_healthy

  # ðŸ”¹ðŸ”¹ NOTIFY_PUSH (HPB)  ðŸ”¹ðŸ”¹
  # Instant sync for desktop clients (Sync 2.0 / High Performance Back-end). Install "Notify push" app in Nextcloud first.
  # ðŸ”— https://github.com/nextcloud/notify_push
  # ðŸ”— https://docs.nextcloud.com/server/stable/admin_manual/installation/source_installation.html#high-performance-back-end
  notify_push:
    container_name: nextcloud-notify-push
    image: nextcloud:stable-apache
    restart: always
    depends_on:
      - nextcloud-web
    environment:
      - PORT=7867
      - NEXTCLOUD_URL=http://nextcloud-web
    entrypoint: ["/bin/sh", "-c", "exec /var/www/html/apps/notify_push/bin/$$(uname -m)/notify_push /var/www/html/config/config.php"]
    volumes:
      - ${PATH_DATA}/nextcloud/web:/var/www/html:ro
    networks:
      - default
      - proxy
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=proxy"
      - "traefik.http.routers.nextcloud-notify-push.rule=Host(`hub.${DEFAULT_DOMAIN}`) && PathPrefix(`/push`)"
      - "traefik.http.routers.nextcloud-notify-push.priority=2"
      - "traefik.http.routers.nextcloud-notify-push.entrypoints=websecure"
      - "traefik.http.middlewares.nextcloud-push-strip.stripprefix.prefixes=/push"
      - "traefik.http.routers.nextcloud-notify-push.middlewares=nextcloud-push-strip"
      - "traefik.http.services.nextcloud-notify-push.loadbalancer.server.port=7867"

  # ðŸ”¹ðŸ”¹ NEXTCLOUD CRON  ðŸ”¹ðŸ”¹
  # Background jobs (cron); runs Nextcloud scheduled tasks.
  # ðŸ”— https://docs.nextcloud.com/server/stable/admin_manual/installation/source_installation.html#running-background-jobs
  nextcloud-cron:
    container_name: nextcloud-cron
    image: nextcloud:apache
    restart: always
    volumes:
      - ${NEXTCLOUD_DATA_DIR}:/data
      - ${PATH_DATA}/nextcloud/web:/var/www/html
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
    entrypoint: /cron.sh
    depends_on:
      - nextcloud-web
      - nextcloud-db
      - nextcloud-cache

  # ðŸ”¹ðŸ”¹ VALKEY (CACHE)  ðŸ”¹ðŸ”¹
  # Redis-compatible cache for Nextcloud (transactional file locking, session, etc.).
  # ðŸ”— https://valkey.io/
  # ðŸ”— https://github.com/valkey-io/valkey
  # ðŸ”— https://docs.nextcloud.com/server/stable/admin_manual/installation/server_tuning.html#redis-configuration
  nextcloud-cache:
    container_name: nextcloud-cache
    image: valkey/valkey:latest
    restart: always
    command: valkey-server --requirepass ${REDIS_HOST_PASSWORD}
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
    environment:
      - REDIS_PORT=6379
      - REDIS_HOST_PASSWORD=${REDIS_HOST_PASSWORD}
    healthcheck:
      test: ["CMD-SHELL", "valkey-cli -a \"$$REDIS_HOST_PASSWORD\" ping | grep -q PONG"]
      interval: 5s
      timeout: 3s
      retries: 30
    labels:
      # Watchtower
#      - "com.centurylinklabs.watchtower.enable=true"

  # ðŸ”¹ðŸ”¹ MARIADB (DATABASE)  ðŸ”¹ðŸ”¹
  # Primary database for Nextcloud (users, metadata, app data).
  # ðŸ”— https://mariadb.org/
  # ðŸ”— https://github.com/MariaDB/server
  # ðŸ”— https://docs.nextcloud.com/server/stable/admin_manual/configuration_database/linux_database_configuration.html
  nextcloud-db:
    container_name: nextcloud-db
    image: mariadb:10.11
    # Nextcloud-recommended: READ-COMMITTED, ROW binlog, utf8mb4; max_allowed_packet helps avoid "MySQL server has gone away".
    command: >
      --transaction-isolation=READ-COMMITTED
      --binlog-format=ROW
      --character-set-server=utf8mb4
      --collation-server=utf8mb4_unicode_ci
      --max-allowed-packet=64M
    restart: always
    environment:
      - MYSQL_DATABASE=nextcloud
      - MYSQL_USER=nextcloud
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
    volumes:
      - ${PATH_DATA}/nextcloud/db:/var/lib/mysql
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
    healthcheck:
      test: ["CMD", "mysql", "-u${MYSQL_USER}", "-p${MYSQL_PASSWORD}", "-e", "use ${MYSQL_DATABASE}"]
      interval: 10s
      timeout: 5s
      retries: 5
      #start_period: 30s
    labels:
      # Watchtower
#      - "com.centurylinklabs.watchtower.enable=true"

  # ðŸ”¹ðŸ”¹ COTURN (TURN)  ðŸ”¹ðŸ”¹
  # TURN server for Nextcloud Talk (WebRTC NAT traversal). Set SERVER_PUBLIC_IP in .env for static IP; leave unset for auto-detect.
  # ðŸ”— https://github.com/coturn/coturn
  # ðŸ”— https://docs.nextcloud.com/server/stable/admin_manual/configuration_server/talk_configuration.html
  nextcloud-turn:
    container_name: nextcloud-turn
    image: coturn/coturn:latest
    restart: always
    environment:
      - SERVER_PUBLIC_IP=${SERVER_PUBLIC_IP:-}
      - DEFAULT_DOMAIN=${DEFAULT_DOMAIN}
      - TURN_SECRET=${TURN_SECRET}
    command: ["/bin/sh", "-c", "set -e; EXTERNAL_IP=$${SERVER_PUBLIC_IP}; if [ -z \"$$EXTERNAL_IP\" ]; then EXTERNAL_IP=$$(wget -qO- https://ifconfig.me/ip 2>/dev/null || wget -qO- https://api.ipify.org 2>/dev/null || true); fi; if [ -z \"$$EXTERNAL_IP\" ]; then echo 'Could not detect public IP and SERVER_PUBLIC_IP is unset'; exit 1; fi; exec turnserver --log-file=stdout --external-ip=$$EXTERNAL_IP --listening-port=3478 --fingerprint --realm=hub.$$DEFAULT_DOMAIN --lt-cred-mech --use-auth-secret --static-auth-secret=$$TURN_SECRET --min-port=49152 --max-port=65535"]
    ports:
      - "3478:3478"
      - "3478:3478/udp"
      - "49152-65535:49152-65535/udp"
    networks:
      - default

  # ðŸ”¹ðŸ”¹ NEXTCLOUD TALK (SPREED SIGNALING)  ðŸ”¹ðŸ”¹
  # Signaling server for Nextcloud Talk (calls, screenshare). Exposed as signal.${DEFAULT_DOMAIN}.
  # ðŸ”— https://nextcloud.com/talk/
  # ðŸ”— https://github.com/strukturag/nextcloud-spreed-signaling
  # ðŸ”— https://docs.nextcloud.com/server/stable/admin_manual/configuration_server/talk_configuration.html
  nextcloud-talk:
    container_name: nextcloud-talk
    image: ghcr.io/strukturag/nextcloud-spreed-signaling:latest
    restart: always
    environment:
      - NC_DOMAIN=hub.${DEFAULT_DOMAIN}

      # Shared secrets you define in .env
      - JWT_SECRET=${TALK_JWT_SECRET}
      - SIGNALING_SECRET=${TALK_SIGNALING_SECRET}
      - TURN_SECRET=${TURN_SECRET}

      # Public TURN URL clients will use
      - TURN_SERVERS=turn:turn.${DEFAULT_DOMAIN}:3478?transport=udp
    networks:
      - default
      - proxy
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=proxy"
      - "traefik.http.routers.nextcloud-talk.rule=Host(`signal.${DEFAULT_DOMAIN}`)"
      - "traefik.http.routers.nextcloud-talk.entrypoints=websecure"
      - "traefik.http.services.nextcloud-talk.loadbalancer.server.port=8080"

  # ðŸ”¹ðŸ”¹ ONLYOFFICE  ðŸ”¹ðŸ”¹
  # Document server for Nextcloud (Office docs, spreadsheets, presentations). Exposed as office.${DEFAULT_DOMAIN}.
  # ðŸ”— https://www.onlyoffice.com/
  # ðŸ”— https://github.com/ONLYOFFICE/DocumentServer
  # ðŸ”— https://helpcenter.onlyoffice.com/installation/docker-installation.aspx
  onlyoffice:
    container_name: onlyoffice
    image: onlyoffice/documentserver:latest
    restart: always
    environment:
      # Recommended for Nextcloud integration
      - JWT_ENABLED=true
      - JWT_SECRET=${ONLYOFFICE_JWT_SECRET}
      - JWT_HEADER=Authorization

      # Optional: helps if you use a reverse proxy (Traefik)
      - USE_UNAUTHORIZED_STORAGE=false
    networks:
      - default
      - proxy
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=proxy"
      - "traefik.http.routers.onlyoffice.rule=Host(`office.${DEFAULT_DOMAIN}`)"
      - "traefik.http.routers.onlyoffice.entrypoints=websecure"
      - "traefik.http.services.onlyoffice.loadbalancer.server.port=80"

networks:
  default:
    name: nc_network
    driver: bridge

  proxy:
    external: true
